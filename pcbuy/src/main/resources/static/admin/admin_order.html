<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description">
    <meta name="author">
    <title>è¨‚å–®ç®¡ç† - å¾Œå°è¨‚å–®ç®¡ç†</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.css" rel="stylesheet">

    <!-- Add custom CSS here -->
    <link href="css/sb-admin.css" rel="stylesheet">
    <link rel="stylesheet" href="css/admin_order.css">
    <link rel="stylesheet" href="css/order_style.css">
    <link rel="stylesheet" href="font-awesome/css/font-awesome.min.css">
  </head>

  <style>
    img{
      width:100px;
      height: 100px;
    }
    input {
      margin: auto;
      text-align: center;
      border-radius: 20px;
      width:25px
    }
    td,th,tr{

      text-align: left;
      font-family:'Times New Roman';
      BORDER-style:none;
      font-size: 20px;

    }
    .center {
      display: block;
      margin-left: auto;
      margin-right: auto;
      width: 50%;
    }

    #cartClear span{
      cursor: pointer;
      display: inline-block;
      position: relative;
      transition: 0.5s;
    }
    #order span {
      cursor: pointer;
      display: inline-block;
      position: relative;
      transition: 0.5s;
    }
    #cartClear span:after{
      content: 'â†º';
      position: absolute;
      opacity: 0;
      top: 0;
      right: -15px;
      transition: 0.5s;
    }
    #order span:after{
      content: 'â ';
      position: absolute;
      opacity: 0;
      top: 0;
      right: -15px;
      transition: 0.5s;
    }
    #cartClear:hover span {
      padding-right: 15px;
    }
    #order:hover span {
      padding-right: 15px;
    }
    #cartClear:hover span:after {
      opacity: 1;
      right: 0;
    }
    #order:hover span:after {
      opacity: 1;
      right: 0;
    }
    .payBtn{
      background-color : green;
      border-radius: 20px;
      color: whitesmoke;
      border: none;
    }
    .cancelBtn{
      background-color : red;
      border-radius: 20px;
      color: whitesmoke;
      border: none;
    }
  </style>

  <body>
    <div id="wrapper">

      <nav class="navbar navbar-inverse navbar-fixed-top" >

        <div class="navbar-header">
          <button type="button" class="navbar-toggle">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="admin_index.html"><img src="../assets/images/logo2.png" style="width: 70px;height: 20px;position: relative"> å¾Œå°ç®¡ç†</a>
        </div>

        <div class="collapse navbar-collapse navbar-ex1-collapse">
          <ul class="nav navbar-nav side-nav">
            <li><a href="admin_index.html"><i class="fa fa-home"></i> é¦–é </a></li>
            <li><a href="admin_member.html"><i class="fa fa-user-md"></i>  æœƒå“¡ç®¡ç† </a></li>
            <li><a href="admin_commodity.html"><i class="fa fa-wrench"></i>  å•†å“ç®¡ç† </a></li>
            <li><a href="admin_order.html"  style="background-color: #e7e7e7; color:black;"><i class="fa fa-file-text"></i>  è¨‚å–®ç®¡ç† </a></li>
            <li><a href="../index.html" style="position:fixed; bottom:20px; left:0;"><i class="fa fa-backward"></i> è¿”å›å®˜ç¶² </a></li>
            <li><a href="/member/member_index.html" style="position:fixed; bottom:70px; left:0;"><i class="fa fa-adjust"></i> ä¸€èˆ¬æ¨¡å¼ </a></li>
          </ul>
          <ul class="nav navbar-nav navbar-right navbar-user">
            <li class="dropdown user-dropdown">
              <a href="#"><i class="fa fa-users"></i> ç®¡ç†å“¡ </a>
            <li class="divider"></li>
            <li><a href="/logout"><i class="fa fa-power-off"></i> Log Out</a></li>
          </ul>
        </div>
      </nav>

      <dialog id="payModal">
        <p> ç¢ºèªè¨‚å–® </p>
        <hr>
        <form action="" method="post" id="pay-form" onsubmit="return paySubmit()">
          <div>
            <label for="name" class="pay-form">æ”¶ä»¶äººå§“åï¼š</label>
            <input disabled type="text" id="name" placeholder="" required maxlength="50"
                   oninvalid="setCustomValidity('è«‹è¼¸å…¥æ‚¨çš„å§“å');" onchange="setCustomValidity('');">

            <label for="tel" class="pay-form">æ”¶ä»¶äººé›»è©±ï¼š</label>
            <input disabled type="text" id="tel" placeholder="" required maxlength="50"
                   oninvalid="setCustomValidity('è«‹è¼¸å…¥æ‚¨çš„é›»è©±');" onchange="setCustomValidity('');">

            <label for="addr" class="pay-form">æ”¶ä»¶äººåœ°å€ï¼š</label>
            <input disabled type="text" id="addr" placeholder="" required maxlength="50"
                   oninvalid="setCustomValidity('è«‹è¼¸å…¥æ‚¨çš„åœ°å€');" onchange="setCustomValidity('');">

            <label for="totalAmount" class="pay-form">è¨‚å–®ç¸½é‡‘é¡ï¼š</label>
            <input disabled type="text" id="totalAmount" placeholder="" required maxlength="50" disabled="disabled">
            <br><br>
            <label class="assembling-form">æ˜¯å¦çµ„è£ï¼š
              <br><br>
              <input disabled type="radio" name="assemblingMethod" value="éœ€çµ„è£">éœ€çµ„è£
              <input disabled type="radio" name="assemblingMethod" value="ä¸çµ„è£">ä¸çµ„è£
              <br><br>
            </label>

            <label class="pay-form">ä»˜æ¬¾æ–¹å¼ï¼š
              <br><br>
              <label class="pay-form"><input disabled type="radio" name="payMethod" value="ç¾é‡‘" checked>è²¨åˆ°ä»˜æ¬¾</label>
              <label class="pay-form"><input disabled="disabled" type="radio" name="payMethod" value="å…å–®">éŠ€è¡Œè½‰å¸³</label>
              <label class="pay-form"><input disabled="disabled" type="radio" name="payMethod" value="å…å–®">ç·šä¸Šä»˜æ¬¾</label>
              <br><br>
            </label>
            <div style="text-align:center;">
              <input type="submit" id="pay-send" value="é€å‡º">
              <input type="button" id="pay-close" value="é—œé–‰">
            </div>
          </div>
        </form>
      </dialog>
      <dialog id="DoubleCheck" style="height: 300px">
        <p style="font-size: x-large">çœŸçš„è¦å–æ¶ˆå—ï¼Ÿ</p>
        <hr>
        <img src="https://i.giphy.com/media/JsVlBMEaHdOEGQKLXB/giphy.webp" class="center" style=" width: 180px; height: 180px">
        <form action="" method="post" id="double-check-form">
          <div style="text-align:center;">
            <input type="button" id="no-send" value="ä¸è¦å–æ¶ˆ">
            <input type="button" id="ok-send" value="å …æ±ºå–æ¶ˆ">
          </div>
        </form>
      </dialog>

        <div id="page-wrapper">
                  <div class="col-lg-12">
                        <h1>æŸ¥è©¢è¨‚å–®</h1>
                        <ol class="breadcrumb">
                          <li><a href="admin_index.html"><i class="fa fa-home"></i> é¦–é  </a></li>
                          <li class="active">è¨‚å–®ç®¡ç† </li>
                        </ol>
                  </div>
            <div class="out" id="allOrder"></div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="js/jquery-1.10.2.js"></script>
    <script src="js/bootstrap.js"></script>
  </body>
  <script type="text/javascript">
    var userId, username, name, tel, addr
    var orderUserId, orderName, orderTel, orderAddr
    var selectOrderId
    var totalAmount
    let payModal = document.querySelector("#payModal")
    let checkModal = document.querySelector("#DoubleCheck")
    var nowState = "hide"
    $(document).ready(function () {
      $.ajax({
        url: '/users/current',
        type: "get",
        dataType: "json",
        success: function (userinfo) {
          if(userinfo.auth.includes('admin')){$('#promodel').show()}
          userId = userinfo.userId
          username = userinfo.username
          name = userinfo.name
          tel = userinfo.tel
          addr = userinfo.addr
          $('#loginName').append(' ' + name)
          $.ajax({
            url: '/admin/' + userId + '/orders',
            type: "get",
            dataType: "json",
            success: function (orders) {
              console.log(orders)
              $.each(orders, function (key, value) {
                if(orders[key].state === "å°šæœªçµå¸³") {
                  $('#allOrder').after('<div class="out"><table class="table" id=' + key + '><tr><th colspan="4" style="vertical-align:middle"><input id='+ orders[key].orderId +' type="button" class="toggleBtn" value=' + 'ğ“º' + '> è¨‚å–®ç·¨è™Ÿï¼š' + orders[key].orderId + '&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp'+ new Date(orders[key].createdDate
                  ).toLocaleDateString()  +'&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspé‡‘é¡ï¼šNT$ '+ orders[key].totalAmount.toLocaleString('zh-TW') +' å…ƒ ï¼ˆ' + orders[key].state +'ï¼‰        <button class="cancelBtn" value=' + orders[key].orderId + '>å–æ¶ˆ<input hidden name='+ orders[key].totalAmount.toLocaleString('zh-TW') +' value=' + orders[key].totalAmount.toLocaleString('zh-TW') +'></th><th></th><th</th><th></th></tr></table></div>')

                } else if(orders[key].state === "æº–å‚™å‡ºè²¨"){
                  $('#allOrder').after('<div class="out"><table class="table" id=' + key + '><tr><th colspan="4" style="vertical-align:middle"><input id='+ orders[key].orderId +' type="button" class="toggleBtn" value=' + 'ğ“º' + '> è¨‚å–®ç·¨è™Ÿï¼š' + orders[key].orderId + '&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp'+ new Date(orders[key].createdDate
                  ).toLocaleDateString()  +'&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspé‡‘é¡ï¼šNT$ '+ orders[key].totalAmount.toLocaleString('zh-TW') +' å…ƒ ï¼ˆ' + orders[key].state +'ï¼‰        <button class="payBtn" value=' + orders[key].orderId + '>å‡ºè²¨<button class="cancelBtn" value=' + orders[key].orderId + '>å–æ¶ˆ<input hidden name='+ orders[key].totalAmount.toLocaleString('zh-TW') +' value=' + orders[key].totalAmount.toLocaleString('zh-TW') +'></th><th></th><th</th><th></th></tr></table></div>')
                } else {
                  $('#allOrder').after('<div class="out"><table class="table" id=' + key + '><tr><th colspan="4" style="vertical-align:middle"><input id='+ orders[key].orderId +' type="button" class="toggleBtn" value=' + 'ğ“º' + '> è¨‚å–®ç·¨è™Ÿï¼š' + orders[key].orderId + '&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp'+ new Date(orders[key].createdDate
                  ).toLocaleDateString()  +'&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp&nbspé‡‘é¡ï¼šNT$ '+ orders[key].totalAmount.toLocaleString('zh-TW') +' å…ƒ ï¼ˆ' + orders[key].state +'ï¼‰<input hidden name='+ orders[key].totalAmount.toLocaleString('zh-TW') +' value=' + orders[key].totalAmount.toLocaleString('zh-TW') +'></th><th></th><th</th><th></th></tr></table></div>')
                }
                $.each(orders[key].orderItemList, function (itemKey, value){
                  $('#'+ key).append('<tr hidden class='+ key +'><td><img src='+ orders[key].orderItemList[itemKey].imageUrl +'/></td><td style="vertical-align:middle">' + orders[key].orderItemList[itemKey].productName + '</td><td  style="vertical-align:middle">' + 'NT$ '+ orders[key].orderItemList[itemKey].amount.toLocaleString('zh-TW') + 'å…ƒ</td><td style="vertical-align:middle">æ•¸é‡' + orders[key].orderItemList[itemKey].quantity + '</td></tr>')
                })
              })
            }
          })
        }
      })
    })
    $(document).on("click", ".toggleBtn",function () {
      var selectedId = $(this).closest('table').attr('id')
      var orderId = $(this).attr('id')
      console.log("selectedId="+selectedId)
      console.log("orderId="+orderId)
      $('.'+selectedId).toggle(300)
    })

    $('#allToggle').click(function () {
      // $('tr[class]').toggle(300)
      if(nowState === "hide"){
        $('tr[class]').show()
        nowState = "show"
      }else {
        $('tr[class]').hide()
        nowState = "hide"
      }
    })

    $(document).on("click", ".payBtn",function () {
      selectOrderId = $(this).val()
      // console.log("ç¾åœ¨è¨‚å–®ID=" + selectOrderId)

      $.ajax({
        url: '/users/' + selectOrderId + '/orderinfo',
        type: "get",
        dataType: "json",
        success: function (orderinfo) {
          $('#name').val(orderinfo.name)
          $('#tel').val(orderinfo.tel)
          $('#addr').val(orderinfo.addr)
          if (orderinfo.assemble === "ä¸çµ„è£")
          $('input[name=assemblingMethod][value="ä¸çµ„è£"]').attr('checked',true)
          else {
            $('input[name=assemblingMethod][value="éœ€çµ„è£"]').attr('checked',true)
          }
          // $('input[name=assemble]:checked').val(orderinfo.assemble)
        }
      })
      //ç”¨orderIdå»ç²å–ä½¿ç”¨è€…è³‡æ–™
      totalAmount = $(this).closest('table').find('input[name]').val()
      $('#totalAmount').val("NT$ " + totalAmount + "å…ƒ")
      payModal.showModal()

    })

    $('#pay-close').click(function () {
      payModal.close()
    })

    $(document).on("click", ".cancelBtn",function () {
      selectOrderId = $(this).val()
      checkModal.showModal()
      $('#ok-send').click(function () {
        $.ajax({
          url: '/users/'+ userId +'/orders',
          type: "put",
          dataType: "text",
          contentType : 'application/json',
          data:JSON.stringify({
            orderId : selectOrderId,
            state:"è¨‚å–®å–æ¶ˆ"
          }),
          success: function (){
            alert("å·²å–æ¶ˆè¨‚å–®")
            location.reload()
            checkModal.close()
          },error:function (data){
            alert("error=" + data)
          }
        })
      })
    })
    $('#no-send').click(function () {
      checkModal.close()
    })

    function paySubmit(){
      console.log('userId='+userId)
      console.log('selectOrderId='+selectOrderId)
      $.ajax({
        url: '/users/'+ userId +'/orders',
        type: "put",
        dataType: "text",
        contentType : 'application/json',
        data:JSON.stringify({
          orderId : selectOrderId,
          state:"å‡ºè²¨å®Œæˆ"
        }),
        success: function (){
          console.log("success")
          alert("å·²å®Œæˆå‡ºè²¨")
          payModal.close()
          location.reload()
        },error:function (data){
          alert("error=" + data)
        }
      })
      return false
    }

  </script>
</html>